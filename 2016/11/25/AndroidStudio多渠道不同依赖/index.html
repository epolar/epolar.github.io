<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="Eraise"><meta name="description" content="简介国内的应用市场太多，时不时就会要求开发者上传应用的时候需要集成他们家的某些SDK，而且还可能是互斥的，比如说百度市场需要集成百度更新但不可以集成360更新，而360市场需要集成360更新而不能集成百度更新。比较傻的方法就是每次要导这两家市场的包，就把代码复制一份集成他们各自的"><meta name="keywords" content=""><title>AndroidStudio多渠道不同依赖 · 我吃西瓜</title><link rel="icon" href="/favicon.ico"><link rel="canonical" href="http://eraise.xyz/2016/11/25/AndroidStudio多渠道不同依赖/"><link rel="alternate" href="/atom.xml" title="我吃西瓜"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="/css/style.css"><script type="text/javascript">var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?92ceb44df626dd88b7190057da6f94e0";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'Your Google Analytics ID', 'auto');
ga('send', 'pageview');</script></head><body><div id="main"><header><a href="/." class="logo">我吃西瓜</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">主页</a></li><li class="nav-link"><a href="/archives" target="_self">文章</a></li><li class="nav-link"><a href="/categories" target="_self">分类</a></li><li class="nav-link"><a href="/tags" target="_self">标签</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">AndroidStudio多渠道不同依赖</h1><span class="post-time">2016年11月25日</span><div id="sidebar" class="post-sidebar"><h3 class="heading">目录</h3><ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#简介"><span class="toc-text">简介</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#基础配置"><span class="toc-text">基础配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#方案一"><span class="toc-text">方案一</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#方案二"><span class="toc-text">方案二</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#疑问"><span class="toc-text">疑问</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#相关资源"><span class="toc-text">相关资源</span></a></li></ol></div><div class="post-content"><h5 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h5><p>国内的应用市场太多，时不时就会要求开发者上传应用的时候需要集成他们家的某些SDK，而且还可能是互斥的，比如说百度市场需要集成百度更新但不可以集成360更新，而360市场需要集成360更新而不能集成百度更新。比较傻的方法就是每次要导这两家市场的包，就把代码复制一份集成他们各自的SDK。不过通过复制，太费力了，于是在网上查了些资料发现可以通过 Gradle 的 <strong>BuildVariant</strong> 构建变体，使不同的渠道拥有不同的依赖，甚至是不同的代码和res资源。</p>
<a id="more"></a>
<h5 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h5><p>在模块的 build.gradle 里配置不同的 flavors:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">android &#123;</div><div class="line">  ... 省略 ...</div><div class="line">  productFlavors &#123;</div><div class="line">        official &#123;&#125;</div><div class="line">        qihoo &#123;&#125;</div><div class="line">        xiaomi &#123;&#125;</div><div class="line">        baidu &#123;&#125;</div><div class="line">        anzhuoshichang &#123;&#125;</div><div class="line">        huawei &#123;&#125;</div><div class="line">        leshangdian &#123;&#125;</div><div class="line">        yingyongbao &#123;&#125;</div><div class="line">        wandoujia &#123;&#125;</div><div class="line">        meizu &#123;&#125;</div><div class="line">        oppo &#123;&#125;</div><div class="line">        jinli &#123;&#125;</div><div class="line"></div><div class="line">        <span class="comment">// 替换掉 manifest 里设置的参数，举个粟子，友盟的：</span></div><div class="line">        <span class="comment">// &lt;meta-data android:name="UMENG_CHANNEL" android:value="$&#123;CHANNEL_VALUE&#125;" /&gt;</span></div><div class="line">        productFlavors.all &#123;</div><div class="line">            flavor -&gt; flavor.manifestPlaceholders = [CHANNEL_VALUE: name]</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">dependencies &#123;</div><div class="line">  ... 省略 ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过上面的配置，就已经可以导出多渠道包了(这种方案导出是省力，可是机子一直在打包，比较慢，可以通过其他方法进行优化)，但是还是不同渠道不同依赖的问题却需要去解决</p>
<h5 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h5><ol>
<li>创建在项目目录里创建好 module，比如百度的就创建个 baiduchannel，所有的模块需要提供一个统一的接口，如：xyz.eraise.channel.CheckUpdate.checkUpdate()</li>
<li>针对不同渠道配置不同的依赖：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">dependencies &#123;</div><div class="line">    compile fileTree(dir: <span class="string">'libs'</span>, <span class="attr">include</span>: [<span class="string">'*.jar'</span>])</div><div class="line">    androidTestCompile(<span class="string">'com.android.support.test.espresso:espresso-core:2.2.2'</span>, &#123;</div><div class="line">        exclude group: <span class="string">'com.android.support'</span>, <span class="attr">module</span>: <span class="string">'support-annotations'</span> <span class="comment">// 去除 com.android.support:support-annotations:xxx 依赖</span></div><div class="line">    &#125;)</div><div class="line">    compile <span class="string">'com.android.support:appcompat-v7:24.2.1'</span></div><div class="line">    testCompile <span class="string">'junit:junit:4.12'</span></div><div class="line"></div><div class="line">    compile project(<span class="string">":officialchannel"</span>) <span class="comment">// 默认渠道配置</span></div><div class="line">    <span class="comment">// 渠道名 + Compile</span></div><div class="line">    baiduCompile project(<span class="string">":baiduchannel"</span>), &#123;</div><div class="line">        exclude <span class="built_in">module</span>: <span class="string">':officialchannel'</span>  <span class="comment">// exclude 关键字排除的是外面写的 officialchannel</span></div><div class="line">        exclude <span class="built_in">module</span>: <span class="string">':library'</span>  <span class="comment">// 对于 baiduchannel 所依赖的 library，依然还是有导入使用的</span></div><div class="line">    &#125;</div><div class="line">    qihooCompile project(<span class="string">':qihoochanner'</span>), &#123;   <span class="comment">// project 名称不能包含数字，包含数字会失败</span></div><div class="line">        exclude <span class="built_in">module</span>: <span class="string">':officialchannel'</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>exclude 会将默认的渠道依赖去除掉，通过这种方案，可以即可得到不同的渠道不同的依赖，不过有个问题是， <strong>eclude 如果排除掉 jar ？</strong> 我找了许久没找到方案，都是通过 compile freeTree(dir: ‘libs’, include: [‘*.jar’], excludes: [‘xxx.jar’]) 事先排除掉不通用的</p>
<h5 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h5><p>相比方案一，这种方案可能更为简单，并且会对不同的渠道可以提供不同的资源文件等，两种方案都能实现我现在的这种需求</p>
<ol>
<li>切换到 Project 视图，各模块，模块下为和 <strong>libs</strong> 和 <strong>src</strong> 两目录</li>
<li>接下来对 src 操刀了，我们需要在 <strong>src</strong> 目录下创建和渠道名称一样的文件夹，该文件夹将和 main 文件夹同层级</li>
<li>在这个文件夹里通过创建同路径的文件来覆盖掉 main 里的文件，比如说 main -&gt; java -&gt; xyz.eraise.channeldemo.CheckUpdate.java，<strong>如果是资源文件的话，会自动合并，res/values/strings.xml 等文件都是会合并的</strong></li>
<li>dependencies 里设置依赖导入不同的依赖包，这跟方案一的一样，不过 <code>exclude</code> 将变成 <code>compile</code></li>
</ol>
<h5 id="疑问"><a href="#疑问" class="headerlink" title="疑问"></a>疑问</h5><ul>
<li>exclude 怎样根据不同的渠道排除 jar？</li>
</ul>
<p><em>Gradle 应该还可以直接处理java代码，不过应该更复杂了</em></p>
<h5 id="相关资源"><a href="#相关资源" class="headerlink" title="相关资源"></a>相关资源</h5><ul>
<li><a href="https://docs.gradle.org/current/userguide/dependency_management.html" target="_blank" rel="external">Gradle依赖配置说明</a></li>
<li><a href="http://www.jianshu.com/p/9b50c4059d61" target="_blank" rel="external">Gradle之多版本打包不同依赖配置</a></li>
<li><a href="http://www.jianshu.com/p/74eba108c80d" target="_blank" rel="external">android 多渠道打包 变种打包（variant）方式</a></li>
<li><a href="http://stackoverflow.com/questions/28137853/gradle-dependency-based-on-both-build-type-and-flavor" target="_blank" rel="external">StackOverFlow上一篇看不懂的文章，看懂求解说</a></li>
<li><a href="http://ofc66dujp.bkt.clouddn.com/ChannelDemo.zip" target="_blank" rel="external">本例源码下载</a></li>
</ul>
</div></article><div class="tags"></div><div class="paginator"><a href="/2016/11/17/NIO-Selector-select-不阻塞/" class="next"><span>下一页</span><i class="iconfont icon-right"></i></a></div><section id="comments"><div data-thread-key="http://eraise.xyz/2016/11/25/AndroidStudio多渠道不同依赖/index.html" data-title="AndroidStudio多渠道不同依赖" data-url="http://eraise.xyz/2016/11/25/AndroidStudio多渠道不同依赖/index.html" class="ds-thread"></div><script type="text/javascript">var duoshuoQuery = {short_name: "eraise" };
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></section></section><footer><div class="social"><a href="mailto:eraise@qq.com" title="email" class="iconfont icon-email"></a><a href="https://github.com/epolar" title="github" class="iconfont icon-github"></a><a href="/atom.xml" title="rss" class="iconfont icon-rss"></a></div><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2016<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">Eraise</span></p></div><div id="back2top"><i class="iconfont icon-up"></i></div></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>